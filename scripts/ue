#!/usr/bin/env zsh

unsetopt bg_nice

HELPER="$(cd `dirname $0` && pwd -P)/../misc/etc/ue-project/helper.py"

choose_map() {
	local project_root=$1
	local choose_map=no
	shift
	for arg in $@; do
		if [ "${arg#-*}" = "$arg" ]; then
			break
		fi
		if [ $arg = "-game" ] || [ $arg = "-m" ]; then
			choose_map=yes
		fi
	done
	if [ "$choose_map" = "yes" ]; then
		local map=$(cd "$project_root/Content" && rg -g '*.umap' --files . 2>/dev/null | peco --prompt="Choose map>")
		if [ -z "$map" ]; then
			exit 1
		fi
		map="/Game/`echo ${map:2} | sed -e 's/\.umap$//'`"
		echo $map
	fi
}

choose_package() {
	local project_root=$1
	shift

	[ -z "$project_root" ] && return 1

	local target_dir="$project_root"

	for _ in `seq 2`; do
		[ $target_dir = "/" ] && return 1
		if [ -d "$target_dir/packages" ]; then
			break
		fi
		target_dir="`dirname $target_dir`"
	done

	if [ -d "$target_dir/packages" ]; then
		target_dir="$target_dir/packages"
	fi

	local name="*.exe"
	local path=`rg -g $name --files $target_dir 2>/dev/null | rg '/WindowsNoEditor/' | peco --prompt="Search '$name' from $target_dir>"`
	echo $path
}

case "$1" in
	generate-project-files)
		shift
		`$HELPER project-files-command "$@"` | nkf -wu
		$HELPER generate-user-support-files "$@" &
		;;
	uat)
		shift
		`$HELPER uat-command "$@"` | nkf -wu
		;;
	build|rebuild|clean)
		mod-configure() {
			sed -i -e 's/#define\s\+ALLOW_PROFILEGPU_IN_TEST\s\+.*$/#define ALLOW_PROFILEGPU_IN_TEST 1/' $1
			# sed -i -e 's/#define\s\+ALLOW_PROFILEGPU_IN_TEST\s\+.*$/#define ALLOW_PROFILEGPU_IN_TEST 0/' $1
			sed -i -e 's/#define\s\+NO_LOGGING\s\+.*$/#define NO_LOGGING 0/' $1
			# sed -i -e 's/#define\s\+FORCE_USE_STATS\s\+.*$/#define FORCE_USE_STATS 1/' $1
			sed -i -e 's/#define\s\+ENABLE_STATNAMEDEVENTS\s\+.*$/#define ENABLE_STATNAMEDEVENTS UE_BUILD_TEST/' $1
			# sed -i -e 's/#define\s\+ENABLE_STATNAMEDEVENTS\s\+.*$/#define ENABLE_STATNAMEDEVENTS 0/' $1
			return 0
		}
		BUILD_H=`$HELPER engine-root`/Source/Runtime/Core/Public/Misc/Build.h
		if [ -f "$BUILD_H" ]; then
			sudo cp $BUILD_H /tmp/Build.h
			mod-configure /tmp/Build.h
			if ! diff $BUILD_H /tmp/Build.h >/dev/null; then
				mod-configure $BUILD_H
			fi
		else
			echo "Not Found: $BUILD_H" >&2
		fi
		`$HELPER build-command "$@"` | nkf -wu
		;;
	cook|package)
		cmd=${1}-command
		shift
		`$HELPER $cmd "$@"` | nkf -wu 
		;;
	packages)
		shift
		package=$(choose_package `$HELPER project-root` "$@")
		`$HELPER launch-command $package "$@"` &
		;;
	editor)
		shift
		map=$(choose_map `$HELPER project-root` "$@")
		`$HELPER launch-command $map "$@"` &
		;;
	*)
		exec $0 editor "$@"
		;;
esac
